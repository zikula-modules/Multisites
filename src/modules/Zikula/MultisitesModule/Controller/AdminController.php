<?php
/**
 * Multisites.
 *
 * @copyright Albert Pérez Monfort (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Albert Pérez Monfort <aperezm@xtec.cat>.
 * @link http://modulestudio.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.7.0 (http://modulestudio.de).
 */

namespace Zikula\MultisitesModule\Controller;

use Zikula\MultisitesModule\Controller\Base\AdminController as BaseAdminController;

use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\Security\Core\Exception\AccessDeniedException;
use ModUtil;

/**
 * Admin controller class providing navigation and interaction functionality.
 */
class AdminController extends BaseAdminController
{
    /**
     * This is the default action handling the mainnull area called without defining arguments.
     *
     * @Route("/admin",
     *        methods = {"GET"}
     * )
     *
     * @param Request  $request      Current request instance
     * @param string  $ot           Treated object type.
     *
     * @return mixed Output.
     *
     * @throws AccessDeniedException Thrown if the user doesn't have required permissions.
     */
    public function indexAction(Request $request)
    {
        // return error if we are not on the main site
        if (!$this->isMainSite() && $this->isConfigured()) {
            throw new AccessDeniedException();
        }

        // return error if no permissions are granted
        $permLevel = ACCESS_ADMIN;
        if (!$this->hasPermission($this->name . '::', '::', $permLevel)) {
            throw new AccessDeniedException();
        }

        // check if configuration is required
        $configRequired = !$this->isConfigured();

        $redirectRoute = null;
        if ($configRequired) {
            $redirectRoute = 'zikulamultisitesmodule_admin_config';
        } else {
            $redirectRoute = 'zikulamultisitesmodule_site_adminview';
        }

        return $this->redirectToRoute($redirectRoute);

    }

    /**
     * Check whether Multisites is running or not.
     *
     * @return boolean True if Multisites properties are available.
     */
    protected function isConfigured()
    {
        global $ZConfig;

        if (!isset($ZConfig['Multisites'])) {
            return false;
        }
        $msConfig = $ZConfig['Multisites'];

        return (isset($msConfig['multisites.enabled']) && $msConfig['multisites.enabled'] == 1
             && isset($msConfig['multisites.mainsiteurl'])
             && isset($msConfig['multisites.based_on_domains']));
    }

    /**
     * Check if the current request is done on the main site or not.
     *
     * @return boolean True if the main site is requested, false otherwise.
     */
    protected function isMainSite()
    {
        global $ZConfig;

        if (!isset($ZConfig['Multisites'])) {
            return true;
        }
        $msConfig = $ZConfig['Multisites'];

        $isBasedOnDomains = isset($msConfig['multisites.based_on_domains']) ? $msConfig['multisites.based_on_domains'] : 1;
        $mainUrl = isset($msConfig['multisites.mainsiteurl']) ? $msConfig['multisites.mainsiteurl'] : '';

        return ($isBasedOnDomains == 0 && $mainUrl == $this->request->query->get('sitedns', '')
            || ($isBasedOnDomains == 1 && $mainUrl == $_SERVER['HTTP_HOST']));
    }

    /**
     * This method takes care of the application configuration.
     *
     * @Route("/config",
     *        methods = {"GET", "POST"}
     * )
     *
     * @return string Output
     *
     * @throws AccessDeniedException Thrown if the user doesn't have required permissions
     */
    public function configAction(Request $request)
    {
        // return error if we are not on the main site
        if (!$this->isMainSite() && $this->isConfigured()) {
            throw new AccessDeniedException();
        }

        // return error if no permissions are granted
        $permLevel = ACCESS_ADMIN;
        if (!$this->hasPermission($this->name . '::', '::', $permLevel)) {
            throw new AccessDeniedException();
        }

        // create new instance of configurator
        $configurator = $this->get('zikula_multisites_module.configurator_helper');
        $configValid = $configurator->verify();

        // if configuration is not completed we show special content
        if (!$configValid) {
            $templateParameters = $configurator->getTemplateParameters();

            return $this->render('@ZikulaMultisitesModule/Admin/wizard.html.twig', $templateParameters);
        }

        // check whether the global administrator has already been configured
        $globalAdminStatus = '';
        if ($this->getVar('globalAdminName', '') == '' || $this->getVar('globalAdminPassword', '') == '' || $this->getVar('globalAdminEmail', '') == '') {
            $globalAdminStatus = $this->__('Please configure the global administrator settings.');
        }
        $this->get('session')->set('globalAdminStatus', $globalAdminStatus);

        // else we call the parent method to render the default configuration form
        return parent::configAction($request);
    }

    /**
     * Core and module update management.
     *
     * @Route("/admin/manageUpdates",
     *        methods = {"GET", "POST"}
     * )
     *
     * @param Request  $request Current request instance
     *
     * @return mixed Output.
     *
     * @throws AccessDeniedException Thrown if the user doesn't have required permissions.
     */
    public function manageUpdatesAction(Request $request)
    {
        // return error if we are not on the main site
        if (!$this->isMainSite() && $this->isConfigured()) {
            throw new AccessDeniedException();
        }

        // check if configuration is required
        $configRequired = !$this->isConfigured();
        if ($configRequired) {
            return $this->redirectToRoute('zikulamultisitesmodule_admin_config');
        }

        return parent::manageUpdatesAction($request);
    }

    /**
     * Provides a generic sql shell.
     *
     * @Route("/admin/multiplyQueries",
     *        methods = {"GET", "POST"}
     * )
     *
     * @param Request  $request Current request instance
     *
     * @return mixed Output.
     *
     * @throws AccessDeniedException Thrown if the user doesn't have required permissions.
     */
    public function multiplyQueriesAction(Request $request)
    {
        // return error if we are not on the main site
        if (!$this->isMainSite() && $this->isConfigured()) {
            throw new AccessDeniedException();
        }

        // return error if no permissions are granted
        $permLevel = ACCESS_ADMIN;
        if (!$this->hasPermission($this->name . '::', '::', $permLevel)) {
            throw new AccessDeniedException();
        }

        // check if configuration is required
        $configRequired = !$this->isConfigured();
        if ($configRequired) {
            return $this->redirectToRoute('zikulamultisitesmodule_admin_config');
        }

        // get all sites
        $sites = ModUtil::apiFunc($this->name, 'selection', 'getEntities', ['ot' => 'site', 'where' => '', 'useJoins' => false]);
        if (false === $sites) {
            return false;
        }

        // build lists of databases, database types and hosts
        $databases = [];
        $databaseTypes = [];
        $databaseHosts = [];

        // add main site
        global $ZConfig;
        $mainDbSettings = $ZConfig['DBInfo']['databases']['default'];
        $databases[] = [
            'alias' => 'multisitesMainSiteAlias',
            'dbname' => $mainDbSettings['dbname'],
            'dbhost' => $mainDbSettings['host'],
            'dbtype' => $mainDbSettings['dbdriver'],
            'dbuname' => $mainDbSettings['user'],
            'dbpass' => $mainDbSettings['password']
        ];

        // add child sites
        foreach ($sites as $site) {
            $dbHost = $site->getDatabaseHost();
            $dbType = $site->getDatabaseType();

            if (!in_array($dbHost, $databaseHosts)) {
                $databaseHosts[] = $dbHost;
            }

            if (!in_array($dbType, $databaseTypes)) {
                $databaseTypes[] = $dbType;
            }

            $databases[] = $site->getDatabaseData();
        }

        $sqlInput = '';
        $sqlOutput = '';
        $databaseHostsSelected = [];
        $databaseTypesSelected = [];

        // check whether the form has been submitted
        if (isset($_POST['submit'])) {
            $inputValid = true;

            $sqlInput = $request->request->get('inputquery', '');
            if (empty($sqlInput) && isset($_FILES['queryfile']) && is_array($_FILES['queryfile']) && isset($_FILES['queryfile']['tmp_name']) && is_file($_FILES['queryfile']['tmp_name']) && is_readable($_FILES['queryfile']['tmp_name'])) {
                $sqlInput = file_get_contents($_FILES['queryfile']['tmp_name']);
            }
            if (empty($sqlInput)) {
                $this->addFlash(\Zikula_Session::MESSAGE_ERROR, $this->__('Error! Please enter some sql commands or provide a sql file.'));
                $inputValid = false;
            }

            $databaseHostsSelected = $request->request->get('dbhosts', []);
            $databaseTypesSelected = $request->request->get('dbtypes', []);
            if (count($databaseHostsSelected) < 1 || count($databaseTypesSelected) < 1) {
                if (count($databaseHostsSelected) < 1) {
                    $this->addFlash(\Zikula_Session::MESSAGE_ERROR, $this->__('Error! Please select at least one database host.'));
                }
                if (count($databaseTypesSelected) < 1) {
                    $this->addFlash(\Zikula_Session::MESSAGE_ERROR, $this->__('Error! Please select at least one database type.'));
                }
                $inputValid = false;
            }

            if ($inputValid === true) {
                $opMode = $request->request->get('opmode', '');
                if (!in_array($opMode, ['show', 'execute'])) {
                    $opMode = 'show';
                }

                $systemHelper = $opMode == 'execute' ? $this->get('zikula_multisites_module.system_helper') : null;

                foreach ($databases as $database) {
                    // check whether the db host should be processed
                    if (!in_array($database['dbhost'], $databaseHostsSelected)) {
                        continue;
                    }
                    // check whether the db type should be processed
                    if (!in_array($database['dbtype'], $databaseTypesSelected)) {
                        continue;
                    }

                    $dbName = $database['dbname'];
                    $sql = str_replace('###DBNAME###', $dbName, $sqlInput);
                    if ($opMode == 'show') {
                        // add sql to output
                        $sqlOutput .= "\n\n";
                        $sqlOutput .= '# ------ ' . $this->__('Site alias') . ': ' . $database['alias'] . ', ' . $this->__('Database name') . ': ' . $dbName . "\n\n";
                        $sqlOutput .= $sql;
                        $sqlOutput .= "\n\n";
                    } elseif ($opMode == 'execute') {
                        // run sql in site database
                        $connect = $systemHelper->connectToExternalDatabase($database);
                        if (!$connect) {
                            $this->addFlash(\Zikula_Session::MESSAGE_ERROR, $this->__f('Error! Connecting to the database %s failed.', [$dbName]));
                            continue;
                        }
                        $stmt = $connect->prepare($sql);
                        if (!$stmt->execute()) {
                            $this->addFlash(\Zikula_Session::MESSAGE_ERROR, $this->__f('Error during executing query in database %s.', [$dbName]));
                        } else {
                            $this->addFlash(\Zikula_Session::MESSAGE_ERROR, $this->__f('Query executed in database %s successfully.', [$dbName]));
                        }
                    }
                }
            }
        } else {
            // select all hosts per default
            foreach ($databaseHosts as $host) {
                $databaseHostsSelected[] = $host;
            }

            // select all types per default
            foreach ($databaseTypes as $dbType) {
                $databaseTypesSelected[] = $dbType;
            }
        }

        $viewHelper = $this->get('zikulamultisitesmodule.view_helper');
        $templateParameters = [
            'databases' => $databases,
            'databaseHosts' => $databaseHosts,
            'databaseTypes' => $databaseTypes,
            'databaseHostsSelected' => $databaseHostsSelected,
            'databaseTypesSelected' => $databaseTypesSelected,
            'sqlInput' => $sqlInput,
            'sqlOutput' => $sqlOutput
        ];

        return $viewHelper->processTemplate($this->get('twig'), 'admin', 'multiplyQueries', $request, $templateParameters);
    }
}
