<?php
/**
 * Multisites.
 *
 * @copyright Albert Pérez Monfort (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Albert Pérez Monfort <aperezm@xtec.cat>.
 * @link http://modulestudio.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.7.0 (http://modulestudio.de).
 */

namespace Zikula\MultisitesModule\Helper;

use DataUtil;
use ModUtil;
use ThemeUtil;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\RequestStack;
use Symfony\Component\HttpFoundation\Session\Session;
use Twig_Environment;
use Zikula\Common\Translator\TranslatorInterface;
use Zikula\Common\Translator\TranslatorTrait;
use Zikula\MultisitesModule\Entity\SiteEntity;

/**
 * Utility class for collecting and persisting site extensions (modules, themes, system plugins, module plugins).
 */
class SiteExtensionHelper
{
    use TranslatorTrait;

    /**
     * @var Session
     */
    protected $session;

    /**
     * The current request.
     *
     * @var Request
     */
    protected $request = null;

    /**
     * The twig environment.
     *
     * @var Twig_Environment
     */
    protected $twig = null;

    /**
     * The workflow helper.
     *
     * @var WorkflowHelper
     */
    protected $workflowHelper = null;

    /**
     * The system helper.
     *
     * @var SystemHelper
     */
    protected $systemHelper = null;

    /**
     * Constructor.
     * Initialises member vars.
     *
     * @param Session             $session        Session service instance.
     * @param TranslatorInterface $translator     Translator service instance.
     * @param RequestStack        $requestStack   RequestStack service instance.
     * @param Twig_Environment    $twig           Twig service instance.
     * @param WorkflowHelper      $workflowHelper WorkflowHelper service instance.
     * @param SystemHelper        $systemHelper   SystemHelper service instance.
     */
    public function __construct(Session $session, TranslatorInterface $translator, RequestStack $requestStack, Twig_Environment $twig, WorkflowHelper $workflowHelper, SystemHelper $systemHelper)
    {
        $this->session = $session;
        $this->setTranslator($translator);
        $this->request = $requestStack->getCurrentRequest();
        $this->twig = $twig;
        $this->workflowHelper = $workflowHelper;
        $this->systemHelper = $systemHelper;
    }

    /**
     * Sets the translator.
     *
     * @param TranslatorInterface $translator Translator service instance.
     */
    public function setTranslator(/*TranslatorInterface */$translator)
    {
        $this->translator = $translator;
    }

    /**
     * Renders the icons that identify the modules availability for a site.
     *
     * @param SiteEntity $site The given site instance.
     * @param array      $args Additional arguments.
     *
     * @return string The rendered output.
     */
    public function getActionIconsForSiteModule(SiteEntity $site, $args)
    {
        $name = isset($args['name']) ? $args['name'] : $this->request->request->get('name', null);
        $available = isset($args['available']) ? $args['available'] : $this->request->request->get('available', null);
        $siteModules = isset($args['siteModules']) ? $args['siteModules'] : $this->request->request->get('siteModules', null);

        $templateParameters = [
            'site' => $site,
            'name' => $name,
            'available' => $available,
            'siteModules' => $siteModules
        ];

        return $this->twig->render('@ZikulaMultisitesModule/Site/iconsModule.html.twig', $templateParameters);
    }

    /**
     * Renders the icons that identify the themes availability for a site.
     *
     * @param SiteEntity $site The given site instance.
     * @param array      $args Additional arguments.
     *
     * @return string The rendered output.
     */
    public function getActionIconsForSiteTheme(SiteEntity $site, $args)
    {
        $name = isset($args['name']) ? $args['name'] : $this->request->request->get('name', null);
        $available = isset($args['available']) ? $args['available'] : $this->request->request->get('available', null);
        $siteThemes = isset($args['siteThemes']) ? $args['siteThemes'] : $this->request->request->get('siteThemes', null);
        $isDefaultTheme = isset($args['isDefaultTheme']) ? $args['isDefaultTheme'] : $this->request->request->get('isDefaultTheme', null);

        $templateParameters = [
            'site' => $site,
            'name' => $name,
            'available' => $available,
            'isDefaultTheme' => $isDefaultTheme,
            'siteThemes', $siteThemes
        ];

        return $this->twig->render('@ZikulaMultisitesModule/Site/iconsTheme.html.twig', $templateParameters);
    }

    /**
     * Retrieves all modules available for a given site.
     *
     * @param SiteEntity $site The given site instance.
     *
     * @return array|boolean An array with a list of the found modules or false on errors.
     */
    public function getAllModulesFromSiteDb(SiteEntity $site)
    {
        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $this->session->getFlashBag()->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $items = [];
        $stmt = $connect->prepare('SELECT `name`, `state`, `version` FROM `modules`');
        $stmt->execute();

        while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
            $items[$row['name']] = $row;
        }

        return $items;
    }

    /**
     * Saves the modules and versions of a site into the Multisites database.
     *
     * @param SiteEntity $site The given site instance.
     *
     * @return boolean True on success or false otherwise.
     */
    public function saveSiteModulesIntoOwnDb(SiteEntity $site)
    {
        // get all the modules available in site
        $siteModules = $this->getAllModulesFromSiteDb($site);

        // save them
        foreach ($siteModules as $module) {
            $entity = new SiteEntityExtension();
            $entity->setName($module['name']);
            $entity->setExtensionVersion($module['version']);
            $entity->setExtensionType('module');
            $this->entityManager->persist($entity);
            $site->addExtensions($entity);
            $success = $this->workflowHelper->executeAction($entity, 'submit');
        }

        //$success = $this->workflowHelper->executeAction($site, 'update');

        return true;
    }

    /**
     * Returns information for a given site module.
     *
     * @param SiteEntity $site       The given site instance.
     * @param string     $moduleName Name of module to select.
     *
     * @return array|boolean An array with the required module information or false on errors.
     */
    public function getModuleFromSiteDb(SiteEntity $site, $moduleName)
    {
        $flashBag = $this->session->getFlashBag();

        if (null === $moduleName || $moduleName == '') {
            $flashBag->add('error', $this->__('Error! Could not do what you wanted. Please check your input.'));

            return false;
        }

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $sql = 'SELECT `name`, `state` FROM `modules`
                WHERE `name` = :moduleName';
        $stmt = $connect->prepare($sql);
        $stmt->execute([':moduleName' => $moduleName]);

        $rs = $stmt->fetch();
        if (!$rs) {
            return false;
        }

        $item = [
            'name' => $rs['name'],
            'state' => $rs['state']
        ];

        return $item;
    }

    /**
     * Creates a module in a site database.
     *
     * @param SiteEntity $site       The given site instance.
     * @param string     $moduleName Name of module to create.
     *
     * @return boolean True on success or false otherwise.
     */
    public function createSiteModule(SiteEntity $site, $moduleName)
    {
        $flashBag = $this->session->getFlashBag();

        if (null === $moduleName || $moduleName == '') {
            $flashBag->add('error', $this->__('Error! Could not do what you wanted. Please check your input.'));

            return false;
        }

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $allModules = ModUtil::apiFunc('ZikulaExtensionsModule', 'admin', 'getfilemodules');
        $module = $allModules[$moduleName];

        $fields = '';
        $values = '';

        $textual = [
            'name',
            'displayname',
            'url',
            'description',
            'directory',
            'version',
            'capabilities',
            'securityschema',
            'core_min',
            'core_max'
        ];

        $exclude = [
            'oldnames',
            'dependencies'
        ];

        foreach ($module as $key => $value) {
            if (!in_array($key, $exclude)) {
                $fields .= $key . ',';
                $apos = in_array($key, $textual) ? "'" : '';
                $valueString = ($value == '') ? "''" : $apos . DataUtil::formatForStore($value) . $apos;
                $values .= $valueString . ',';
            }
        }
        $fields = substr($fields, 0, -1);
        $values = substr($values, 0, -1);
        // set module state to 1
        $fields .= ', state';
        $values .= ', 1';

        //create the module in the site
        $sql = "INSERT INTO modules ($fields)
                VALUES ($values)";
        $rs = $connect->query($sql);
        if (!$rs) {
            $flashBag->add('error', $this->__('Error! Creation attempt failed.' . $sql));

            return false;
        }

        return true;
    }

    /**
     * Deletes a module from a site database.
     *
     * @param SiteEntity $site       The given site instance.
     * @param string     $moduleName Name of module to delete.
     *
     * @return boolean True on success or false otherwise.
     */
    public function deleteSiteModule(SiteEntity $site, $moduleName)
    {
        $flashBag = $this->session->getFlashBag();

        if (null === $moduleName || $moduleName == '') {
            $flashBag->add('error', $this->__('Error! Could not do what you wanted. Please check your input.'));

            return false;
        }

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        // get module information
        $siteModule = $this->getModuleFromSiteDb($site, $moduleName);

        if ($siteModule['state'] == ModUtil::STATE_ACTIVE) {
            $this->modifyModuleActivation($site, [
                'moduleName' => $moduleName,
                'newState' => ModUtil::STATE_INACTIVE
            ]);

            return true;
        }

        if ($siteModule['state'] == ModUtil::STATE_INACTIVE) {
            return true;
        }

        $sql = 'DELETE FROM `modules`
                WHERE `name` = :moduleName';
        $stmt = $connect->prepare($sql);
        if (!$stmt->execute([':moduleName' => $moduleName])) {
            $flashBag->add('error', $this->__('Error! Sorry! Deletion attempt failed.'));

            return false;
        }

        return true;
    }

    /**
     * Modifies the state of a module in a site database.
     *
     * @param SiteEntity $site The given site instance.
     * @param array      $args Additional arguments.
     *
     * @return boolean True on success or false otherwise.
     */
    public function modifyModuleActivation(SiteEntity $site, $args)
    {
        $moduleName = $args['moduleName'];
        $newState = $args['newState'];

        $flashBag = $this->session->getFlashBag();

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        // update the module state
        $sql = 'UPDATE `modules`
                SET `state` = :newState
                WHERE `name` = :moduleName';
        $stmt = $connect->prepare($sql);
        if (!$stmt->execute([':moduleName' => $moduleName, ':newState' => $newState])) {
            $flashBag->add('error', $this->__('Error! Update attempt failed.'));

            return false;
        }

        return true;
    }

    /**
     * Retrieves all themes available in the themes directory.
     *
     * @return array All existing theme names.
     */
    public function getAllThemesInSystem()
    {
        $themeBaseFolder = 'themes';
        $themes = [];
        if (!file_exists($themeBaseFolder) || !is_dir($themeBaseFolder)) {
            return $themes;
        }

        $flashBag = $this->session->getFlashBag();

        $dh = opendir($themeBaseFolder);
        $dirArray = [];
        while ($dir = readdir($dh)) {
            if (in_array($dir, ['.', '..', '.git', '.svn', 'CVS', 'index.html', 'index.htm', '.htaccess'])) {
                continue;
            }
            if (!is_dir($themeBaseFolder . '/' . $dir)) {
                continue;
            }
            $dirArray[] = $dir;
        }
        closedir($dh);

        foreach ($dirArray as $dir) {
            $themeFolder = $themeBaseFolder . '/' . $dir . '/';
            $themeType = 0;
            $themeversion = [];

            // Work out the theme type
            if (file_exists($themeFolder . 'theme.cfg') && file_exists($themeFolder . 'theme.php')) {
                $themeType = 4;
            } elseif (file_exists($themeFolder . 'version.php') && !file_exists($themeFolder . 'theme.php')) {
                $themeType = 3;
            } elseif (file_exists($themeFolder . 'xaninit.php') && file_exists($themeFolder . 'theme.php')) {
                // xanthia 2.0 themes will need upgrading so set the theme state to inactive
                $themeversion['state'] = ThemeUtil::STATE_INACTIVE;
                $themeType = 2;
            } elseif (file_exists($themeFolder . 'theme.php')) {
                $themeType = 1;
            } else {
                // anything else isn't a theme
                continue;
            }

            // Set some defaults in case we don't have a theme version file
            $themeversion['name'] = preg_replace('/_/', ' ', $dir);
            $themeversion['displayname'] = preg_replace('/_/', ' ', $dir);
            $themeversion['version'] = '0';
            $themeversion['description'] = '';
            // include the correct version file based on theme type and
            // manipulate the theme version information
            if (file_exists($file = $themeFolder . 'version.php')) {
                if (!include($file)) {
                    $flashBag->add('error', $this->__f('Error! Could not include %s', ['%s' => $file]));
                }
            } elseif ($themeType == 4 && file_exists($file = $themeFolder . 'theme.cfg')) {
                if (!include($file)) {
                    $flashBag->add('error', $this->__f('Error! Could not include %s', ['%s' => $file]));
                }
                if (!isset($themeversion['name'])) {
                    $themeversion['name'] = $dir;
                }
                $themeversion['displayname'] = $themeversion['name'];
            } elseif ($themeType == 2 && file_exists($file = $themeFolder . 'xaninfo.php')) {
                $themeinfo = [];
                if (!include($file)) {
                    $flashBag->add('error', $this->__f('Error! Could not include %s', ['%s' => $file]));

                    return false;
                }
                $themeversion['author'] = $themeinfo['author'];
                $themeversion['contact'] = $themeinfo['download'];
                $themeversion['name'] = $themeinfo['name'];
                $themeversion['displayname'] = $themeinfo['name'];
                $themeversion['xhtml'] = $themeinfo['xhtmlsupport'];
            }
            $themes[$themeversion['name']] = [
                'directory'     => $dir,
                'name'          => $themeversion['name'],
                'type'          => $themeType,
                'displayname'   => (isset($themeversion['displayname']) ? $themeversion['displayname'] : $themeversion['name']),
                'version'       => (isset($themeversion['version']) ? $themeversion['version'] : '1.0'),
                'description'   => (isset($themeversion['description']) ? $themeversion['description'] : $themeversion['displayname']),
                'admin'         => (isset($themeversion['admin']) ? (int) $themeversion['admin'] : '0'),
                'user'          => (isset($themeversion['user']) ? (int) $themeversion['user'] : '1'),
                'system'        => (isset($themeversion['system']) ? (int) $themeversion['system'] : '0'),
                'state'         => (isset($themeversion['state']) ? $themeversion['state'] : ThemeUtil::STATE_ACTIVE),
                'official'      => (isset($themeversion['offical']) ? (int) $themeversion['offical'] : '0'),
                'author'        => (isset($themeversion['author']) ? $themeversion['author'] : ''),
                'contact'       => (isset($themeversion['contact']) ? $themeversion['contact'] : ''),
                'credits'       => (isset($themeversion['credits']) ? $themeversion['credits'] : ''),
                'help'          => (isset($themeversion['help']) ? $themeversion['help'] : ''),
                'changelog'     => (isset($themeversion['changelog']) ? $themeversion['changelog'] : ''),
                'license'       => (isset($themeversion['license']) ? $themeversion['license'] : ''),
                'xhtml'         => (isset($themeversion['xhtml']) ? (int) $themeversion['xhtml'] : 1)
            ];

            // reset vars for next iteration
            unset($themeversion);
            unset($themeType);
        }

        ksort($themes);

        return $themes;
    }

    /**
     * Retrieves all themes available for a given site.
     *
     * @param SiteEntity $site The given site instance.
     *
     * @return array|boolean List of found themes or false on errors.
     */
    public function getAllThemesFromSiteDb(SiteEntity $site)
    {
        $flashBag = $this->session->getFlashBag();

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $items = [];
        $stmt = $connect->prepare('SELECT `name`, `state` FROM `themes`');
        $stmt->execute();

        while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
            $items[$row['name']] = $row;
        }

        return $items;
    }

    /**
     * Returns information for a given site theme.
     *
     * @param SiteEntity $site      The given site instance.
     * @param string     $themeName Name of theme to select.
     *
     * @return array|boolean An array with the required theme information or false on errors.
     */
    public function getThemeFromSiteDb(SiteEntity $site, $themeName)
    {
        $flashBag = $this->session->getFlashBag();

        if (null === $themeName || $themeName == '') {
            $flashBag->add('error', $this->__('Error! Could not do what you wanted. Please check your input.'));

            return false;
        }

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $sql = 'SELECT `name`, `state`
                FROM `themes`
                WHERE `name` = :themeName';
        $stmt = $connect->prepare($sql);
        $stmt->execute([':themeName' => $themeName]);

        $rs = $stmt->fetch();
        if (!$rs) {
            //$flashBag->add('error', $this->__('Error! Could not load items.'));

            //return false;
        }
        $item = [
            'name' => $rs['name'],
            'state' => $rs['state']
        ];

        return $item;
    }

    /**
     * Creates a theme in a site database.
     *
     * @param SiteEntity $site      The given site instance.
     * @param string     $themeName Name of theme to create.
     *
     * @return boolean True on success or false otherwise.
     */
    public function createSiteTheme(SiteEntity $site, $themeName)
    {
        $flashBag = $this->session->getFlashBag();

        if (null === $themeName || $themeName == '') {
            $flashBag->add('error', $this->__('Error! Could not do what you wanted. Please check your input.'));

            return false;
        }

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $allThemes = $this->getAllThemesInSystem();
        $theme = $allThemes[$themeName];

        $fields = '';
        $values = '';

        $textual = [
            'name',
            'displayname',
            'description',
            'directory',
            'version',
            'contact'
        ];

        $exclude = [
            'official',
            'author',
            'credits',
            'help',
            'changelog',
            'license'
        ];

        foreach ($theme as $key => $value) {
            if (!in_array($key, $exclude)) {
                $fields .= $key . ',';
                $apos = (in_array($key, $textual)) ? "'" : '';
                $valueString = ($value == '') ? "''" : $apos . DataUtil::formatForStore($value) . $apos;
                $values .= $valueString . ',';
            }
        }

        $fields = substr($fields, 0, -1);
        $values = substr($values, 0, -1);

        //create the theme in the site
        $sql = "INSERT INTO themes ($fields)
                VALUES ($values)";
        $rs = $connect->query($sql);
        if (!$rs) {
            $flashBag->add('error', $this->__('Error! Creation attempt failed.' . $sql));

            return false;
        }

        return true;
    }

    /**
     * Deletes a theme from a site database.
     *
     * @param SiteEntity $site      The given site instance.
     * @param string     $themeName Name of theme to delete.
     *
     * @return boolean True on success or false otherwise.
     */
    public function deleteSiteTheme(SiteEntity $site, $themeName)
    {
        $flashBag = $this->session->getFlashBag();

        if (null === $themeName || $themeName == '') {
            $flashBag->add('error', $this->__('Error! Could not do what you wanted. Please check your input.'));

            return false;
        }

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $sql = 'DELETE FROM `themes`
                WHERE `name` = :themeName';
        $stmt = $connect->prepare($sql);
        if (!$stmt->execute([':themeName' => $themeName])) {
            $flashBag->add('error', $this->__('Error! Sorry! Deletion attempt failed.'));

            return false;
        }

        return true;
    }

    /**
     * Gets the default theme for a site.
     *
     * @param SiteEntity $site The given site instance.
     *
     * @return string Name of site default theme.
     */
    public function getSiteDefaultTheme(SiteEntity $site)
    {
        $flashBag = $this->session->getFlashBag();

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $sql = 'SELECT `value`
                FROM `module_vars`
                WHERE `modname` = \'ZConfig\'
                AND `name` = \'Default_Theme\'';
        $stmt = $connect->prepare($sql);
        if (!$stmt->execute()) {
            $flashBag->add('error', $this->__('Error! Could not load default theme.'));

            return false;
        }
        $rs = $stmt->fetch();
        $defaultTheme = $rs['value'];

        return $defaultTheme;
    }

    /**
     * Update the site default theme
     *
     * @param SiteEntity $site      The given site instance.
     * @param string     $themeName Name of new default theme.
     *
     * @return boolean True on success or false otherwise.
     */
    public function setAsDefaultTheme(SiteEntity $site, $themeName)
    {
        $flashBag = $this->session->getFlashBag();

        $connect = $this->systemHelper->connectToExternalDatabase($site->getDatabaseData());
        if (!$connect) {
            $flashBag->add('error', $this->__f('Error! Connecting to the database %s failed.', ['%s' => $site->getDatabaseName()]));

            return false;
        }

        $value = serialize($themeName);
        $sql = 'UPDATE `module_vars`
                SET `value` = :value
                WHERE `modname` = \'ZConfig\'
                AND `name` = \'Default_Theme\'';
        $stmt = $connect->prepare($sql);
        if (!$stmt->execute([':value' => $value])) {
            $flashBag->add('error', $this->__('Error! Could not save the new default theme.'));

            return false;
        }

        return true;
    }
}
