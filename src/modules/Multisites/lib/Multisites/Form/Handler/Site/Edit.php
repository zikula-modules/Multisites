<?php
/**
 * Multisites.
 *
 * @copyright Albert Pérez Monfort (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @package Multisites
 * @author Albert Pérez Monfort <aperezm@xtec.cat>.
 * @link http://modulestudio.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.7.0 (http://modulestudio.de).
 */

/**
 * This handler class handles the page events of the Form called by the multisites_site_edit() function.
 * It aims on the site object type.
 */
class Multisites_Form_Handler_Site_Edit extends Multisites_Form_Handler_Site_Base_Edit
{
    /**
     * Configuration application helper.
     * @var Multisites_Util_System
     */
    private $systemHelper;

    /**
     * Post-initialise hook.
     *
     * @return void
     */
    public function postInitialize()
    {
        parent::postInitialize();

        $site = $this->view->get_template_vars('site');

        $site['databaseTypeItems'] = array(
            array('value' => 'mysql', 'text' => $this->__('MySQL')),
            array('value' => 'mysqli', 'text' => $this->__('MySQL Improved')),
            array('value' => 'postgres', 'text' => $this->__('PostgreSQL'))/*,
            array('value' => 'oci', 'text' => $this->__('Oracle'))*/
        );

        $this->view->assign('site', $site);
    }

    /**
     * Input data processing called by handleCommand method.
     *
     * @param Zikula_Form_View $view The form view instance.
     * @param array            $args Additional arguments.
     *
     * @return array form data after processing.
     */
    public function fetchInputData(Zikula_Form_View $view, &$args)
    {
        $isDecoupledSite = is_null($this->entityRef['template']);

        $otherFormData = parent::fetchInputData($view, $args);

        // get treated entity reference from persisted member var
        $entity = $this->entityRef;

        if (!ctype_lower($entity['siteAlias'])) {
            return LogUtil::registerError($this->__('Error! The site alias may contain only lowercase letters.'));
        }

        if (!System::varValidate($entity['siteAdminName'], 'uname')) {
            return LogUtil::registerError($this->__('The user name you entered for the site administrator contains unacceptable characters. A valid user name consists of lowercase letters, numbers, underscores, periods, and/or dashes.'));
        }

        if (!is_null($entity['template']) && count($entity['template']['parameters']) > 0) {
            // check if parameters have been provided
            if (!$entity['parametersCsvFile'] && (is_null($entity['parametersArray']) || !count($entity['parametersArray']))) {
                return LogUtil::registerError($this->__('Error! Please either provide a csv file containing the required parameter values or enter them manually.'));
            }
        }

        // create helper instance for config application
        $this->systemHelper = new Multisites_Util_System($this->view->getServiceManager());

        if ($this->mode == 'create') {
            if (is_null($entity['template'])) {
                return LogUtil::registerError($this->__('Error! You need to select a template for new sites.'));
            }

            $createNewDatabase = isset($otherFormData['additions']) && is_array($otherFormData['additions']) && isset($otherFormData['additions']['createNewDatabase']) && $otherFormData['additions']['createNewDatabase'] == 1;
            if (!$this->prepareNewSite($entity, $createNewDatabase)) {
                return false; // error has been registered already
            }
        } else {
            // check if database connection works
            $connect = $this->systemHelper->connectToExternalDatabase($entity->getDatabaseData());
            if (!$connect) {
                return LogUtil::registerError($this->__('Error! Connecting to the database failed.'));
            }
        }

        if ($this->mode != 'create') {
            // check if site has been decoupled from it's template
            // we use $_POST directly on purpose here, since the Form plugin changes the result
            $templateIdArray = isset($_POST['template']) && is_array($_POST['template']) ? $_POST['template'] : array();
            if (isset($templateIdArray[0])) {
                if (!$isDecoupledSite && $templateIdArray[0] == '') {
                    // decouple site

                    // remove template assignment from site
                    $entity->setTemplate(null);

                    // save entity reference for later reuse
                    $this->entityRef = $entity;
                } elseif (!is_null($entity['template'])) {
                    // couple again

                    // insert database content
                    if (!$this->systemHelper->setupDatabaseContent($entity)) {
                        return false; // error has been registered already
                    }
                }
            }
        }

        return $otherFormData;
    }

    /**
     * Performs preparation work and advanced checks before a new site is persisted.
     *
     * @param Multisites_Entity_Site entity            The currently treated site instance.
     * @param boolean                createNewDatabase If true then the database is created, defaults to false.
     *
     * @return boolean True on success or false otherwise.
     */
    protected function prepareNewSite($entity, $createNewDatabase = false)
    {
        // check whether the sitedns already exists and return an error it this is the case
        $repository = $this->entityManager->getRepository('Multisites_Entity_Site');
        $sites = $repository->getSiteInfo($entity['siteDns']);
        if (!is_null($sites) && count($sites) > 0) {
            return LogUtil::registerError($this->__('This site exists already. The site DNS must be unique.'));
        }

        // perform also a duplicate check for the alias
        $where = 'tbl.siteAlias = \'' . $entity['siteAlias'] . '\'';
        $sites = $repository->selectWhere($where, '', false);
        if (!is_null($sites) && count($sites) > 0) {
            return LogUtil::registerError($this->__('This site exists already. The site alias must be unique.'));
        }

        // perform some preparation work for the new site

        // create initial folders for the new site
        if (!$this->systemHelper->createSiteFolders($entity)) {
            return false; // error has been registered already
        }

        // check if database connection works
        $connect = $this->systemHelper->connectToExternalDatabase($entity->getDatabaseData());
        if (!$connect) {
            return LogUtil::registerError($this->__('Error! Connecting to the database failed.'));
        }

        if ($createNewDatabase) {
            // create a new database if it does not exist yet
            if (!$this->systemHelper->createDatabase($entity->getDatabaseData())) {
                return LogUtil::registerError($this->__('Error! Creation of database failed.'));
            }
        }

        // insert database content
        if (!$this->systemHelper->setupDatabaseContent($entity)) {
            return false; // error has been registered already
        }

        // create .htaccess file
        if (!$this->systemHelper->createHtAccessForTempFolder($entity)) {
            return false; // error has been registered already
        }

        return true;
    }
}
