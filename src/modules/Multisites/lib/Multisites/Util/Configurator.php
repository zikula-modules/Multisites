<?php
/**
 * Multisites.
 *
 * @copyright Albert Pérez Monfort (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @package Multisites
 * @author Albert Pérez Monfort <aperezm@xtec.cat>.
 * @link http://modulestudio.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.7.0 (http://modulestudio.de).
 */

/**
 * Utility class for configuration related functionality.
 */
class Multisites_Util_Configurator extends Zikula_AbstractBase
{
    /**
     * Reference to view instance.
     *
     * @var Zikula_View
     */
    private $view;

    /**
     * Primary configuration file path.
     *
     * @var string
     */
    private $configFile;

    /**
     * Database configuration file path.
     *
     * @var string
     */
    private $dbConfigFile;

    /**
     * Primary configuration template file path.
     *
     * @var string
     */
    private $configTemplateFile;

    /**
     * Database configuration template file path.
     *
     * @var string
     */
    private $dbConfigTemplateFile;


    /**
     * Initialize: called from constructor.
     *
     * Intended for initialising base classes.
     *
     * @return void
     */
    protected function initialize()
    {
        $this->configFile = 'config/multisites_config.php';
        $this->dbConfigFile = 'config/multisites_dbconfig.php';
        $this->configTemplateFile = 'modules/Multisites/Resources/' . $this->configFile;
        $this->dbConfigTemplateFile = 'modules/Multisites/Resources/' . $this->dbConfigFile;
    }

    /**
     * Checks whether Multisites configuration is existing and well-formed.
     *
     * @param Zikula_View The given view instance, used for assigning errors and other vars.
     *
     * @return boolean True if everything is okay, false otherwise.
     */
    public function verify(Zikula_View $view)
    {
        $this->view = $view;

        if (!$this->isMultisitesEnabled()) {
            // step 1 - check if required files are located in the correct place and whether they are writeable
            if (!$this->checkConfigurationFiles()) {
                $view->assign('step', 1);
                return false;
            }

            // step 2 - check if the files folder exists and ask for the physical path
            $filesRealPath = $this->getVar('files_real_path', '');
            if (empty($filesRealPath) || !file_exists($filesRealPath)) {
                $paramsValid = false;
                $filesRealPath = $this->request->request->get('files_real_path', null);
                if ($filesRealPath !== null) {
                    // value is sent via POST, try to save it
                    if ($this->writeFilesPathToConfig($filesRealPath)) {
                        // save in modvar temporarily
                        $this->setVar('files_real_path', $filesRealPath);
                        $paramsValid = true;
                    }
                }
                if ($paramsValid !== true) {
                    // ask for the correct location for the sites folder where the Temp folders will be created.
                    $scriptRealPath = substr($_SERVER['SCRIPT_FILENAME'], 0, strrpos($_SERVER['SCRIPT_FILENAME'], '/'));
                    $filesRealPath = $scriptRealPath . '/' . $GLOBALS['ZConfig']['System']['datadir'] . '/msData';

                    $view->assign('step', 2)
                         ->assign('files_real_path', $filesRealPath)
                         ->assign('scriptRealPath', $scriptRealPath);
                    return false;
                }
            }

            // step 3 - define multisites system parameters
            $mainSiteUrl = $this->getVar('mainsiteurl', '');
            $siteTempFilesFolder = $this->getVar('site_temp_files_folder', '');
            $siteFilesFolder = $this->getVar('site_files_folder', '');
            if (empty($mainSiteUrl) || empty($siteTempFilesFolder) || empty($siteFilesFolder)) {
                $paramsValid = false;
                $mainSiteUrl = $this->request->request->get('mainsiteurl', null);
                $siteTempFilesFolder = $this->request->request->get('site_temp_files_folder', null);
                $siteFilesFolder = $this->request->request->get('site_files_folder', null);
                if ($mainSiteUrl !== null && $siteTempFilesFolder !== null && $siteFilesFolder !== null) {
                    // values are sent via POST, try to save them
                    if ($this->writeSystemParametersToConfig($mainSiteUrl, $siteTempFilesFolder, $siteFilesFolder)) {
                        if ($this->createAdditionalDirectories()) {
                            // save parameters in modvars temporarily
                            $this->setVar('mainsiteurl', $mainSiteUrl);
                            $this->setVar('site_temp_files_folder', $siteTempFilesFolder);
                            $this->setVar('site_files_folder', $siteFilesFolder);
                            $paramsValid = true;

                            $htAccessContent = 'SetEnvIf Request_URI "\.css$" object_is_css=css' . "\n";
                            $htAccessContent .= 'SetEnvIf Request_URI "\.js$" object_is_js=js' . "\n";
                            $htAccessContent .= 'Order deny, allow' . "\n";
                            $htAccessContent .= 'Deny from all' . "\n";
                            $htAccessContent .= 'Allow from env=object_is_css' . "\n";
                            $htAccessContent .= 'Allow from env=object_is_js' . "\n";

                            $this->setVar('tempAccessFileContent', $htAccessContent);
                        }
                    }
                }

                if ($paramsValid !== true) {
                    // ask for multisites system parameters

                    // get server zikula folder installation
                    $path = substr($_SERVER['PHP_SELF'], 0, strrpos($_SERVER['PHP_SELF'], '/'));
                    $basePath = substr($path, 0, strrpos($path, '/'));

                    $view->assign('step', 3)
                         ->assign('configFile', $this->configFile)
                         ->assign('dbConfigFile', $this->dbConfigFile)
                         ->assign('mainSiteUrl', $_SERVER['HTTP_HOST'])
                         ->assign('siteTempFilesFolder', $GLOBALS['ZConfig']['System']['temp'])
                         ->assign('siteFilesFolder', 'data');
                    return false;
                }
            }

            // Step 4 - Check if config file is still writeable
            $configFileWriteable = file_exists($this->configFile) && is_writeable($this->configFile);
            if ($configFileWriteable) {
                $view->assign('step', 4)
                     ->assign('configFile', $this->configFile)
                     ->assign('configFileWriteable', true);
                return false;
            }

            return LogUtil::registerError($this->__('Error: it seems everything is configured correctly, but Multisites is not running. Please check your configuration file!'));
        }

        // Multisites is enabled

        // cleanup
        $this->delVar('files_real_path');
        $this->delVar('mainsiteurl');
        $this->delVar('site_temp_files_folder');
        $this->delVar('site_files_folder');

        // check if the multisites_config.php file is writeable (it should not)
        $configFileWriteable = file_exists($this->configFile) && is_writeable($this->configFile);
        if ($configFileWriteable) {
            $view->assign('step', 4)
                 ->assign('configFile', $this->configFile)
                 ->assign('configFileWriteable', true);
            return false;
        }

        return true;
    }

    /**
     * Checks whether the Multisites system is enabled or not.
     *
     * @return boolean True if Multisites is active, false otherwise.
     */
    private function isMultisitesEnabled()
    {
        global $ZConfig;

        return isset($ZConfig['Multisites']['multisites.enabled']) && $ZConfig['Multisites']['multisites.enabled'] == 1;
    }

    /**
     * Checks whether the Multisites configuration files exist and are writable.
     * Tries to setup the files automatically if possible.
     *
     * @return boolean True if all files are setup well, false otherwise.
     */
    private function checkConfigurationFiles()
    {
        $configFileExists = file_exists($this->configFile);
        if (!$configFileExists && @copy($this->configTemplateFile, $this->configFile)) {
            $configFileExists = file_exists($this->configFile);
        }

        $dbConfigFileExists = file_exists($this->dbConfigFile);
        if (!$dbConfigFileExists && @copy($this->dbConfigTemplateFile, $this->dbConfigFile)) {
            $dbConfigFileExists = file_exists($this->dbConfigFile);
        }

        $configFileWriteable = $configFileExists && is_writeable($this->configFile);
        if ($configFileExists && !$configFileWriteable && @chmod($this->configFile, 0755)) {
            $configFileWriteable = is_writeable($this->configFile);
        }

        $dbConfigFileWriteable = $dbConfigFileExists && is_writeable($this->dbConfigFile);
        if ($dbConfigFileExists && !$dbConfigFileWriteable && @chmod($this->dbConfigFile, 0755)) {
            $dbConfigFileWriteable = is_writeable($this->dbConfigFile);
        }

        $result = ($configFileWriteable && $dbConfigFileWriteable);

        $mainSiteUrl = $this->getVar('mainsiteurl', '');
        if ($mainSiteUrl != '') {
            // configuration has been done almost completely
            // primary config file does not need to be writeable anymore
            $result = $dbConfigFileWriteable;
        }

        $this->view->assign('configFile', $this->configFile)
                   ->assign('dbConfigFile', $this->dbConfigFile)
                   ->assign('configTemplateFile', $this->configTemplateFile)
                   ->assign('dbConfigTemplateFile', $this->dbConfigTemplateFile)
                   ->assign('configFileExists', $configFileExists)
                   ->assign('dbConfigFileExists', $dbConfigFileExists)
                   ->assign('configFileWriteable', $configFileWriteable)
                   ->assign('dbConfigFileWriteable', $dbConfigFileWriteable);

        return $result;
    }

    /**
     * Checks whether the given files directory is existing and writeable or not.
     * Tries to create the directory and/or make it writeable if required.
     *
     * @param string Path to the physical files folder.
     *
     * @return boolean True if directory exists and is writeable, false otherwise.
     */
    private function checkWriteableDirectory($filesPath)
    {
        if ($filesPath == '') {
            return LogUtil::registerError($this->__('The directory where the sites files have to be created is not defined. Please, define it.'));
        }
        if (!file_exists($filesPath)) {
            if (!@mkdir($filesPath, 0777, true) || !file_exists($filesPath)) {
                return LogUtil::registerError($this->__('The directory where the sites files have to be created does not exist. Please, create it.'));
            }
        }
        // check if the sitesFilesFolder is writeable
        if (!is_writeable($filesPath)) {
            return LogUtil::registerError($this->__('The directory where the sites files have to be created is not writeable. Please, set it as writeable.'));
        }

        return true;
    }

    /**
     * Writes physical folder path into the config/multisites_config.php file.
     *
     * @param string Path to the physical files folder.
     *
     * @return boolean True if everything worked, false otherwise.
     */
    private function writeFilesPathToConfig($filesPath)
    {
        // Check permissions
        $this->throwForbiddenUnless(SecurityUtil::checkPermission($this->name . '::', '::', ACCESS_ADMIN));

        // check if the folder exists and is writeable
        if (!$this->checkWriteableDirectory($filesPath)) {
            return false;
        }

        // write parameter into the multisites_config.php file
        $fh = @fopen($this->configFile, 'r+');
        if ($fh == false) {
            fclose($fh);
            return LogUtil::registerError($this->__('Error: File config/multisites_config.php could not be found.'));
        }

        $lines = file($this->configFile);
        $newFileContent = '';

        foreach ($lines as $line_num => $line) {
            if (strpos($line, "ZConfig['Multisites']['multisites.files_real_path']") !== false) {
                $line = str_replace('$files_real_path', $filesPath, $line);
            }
            $newFileContent .= $line;
        }

        // write new content into the file
        $fh = @fopen($this->configFile, 'w+');
        if (!fwrite($fh, $newFileContent)) {
            fclose($fh);
            return LogUtil::registerError($this->__('Error: Could not write into the config/multiple_config.php file.'));
        }
        fclose($fh);

        return true;
    }

    /**
     * Writes multisites system parameters into the config/multisites_config.php file.
     *
     * @param string Domain for the main site.
     * @param string Path to folder for temporary sites files.
     * @param string Path to folder for sites files.
     *
     * @return boolean True if everything worked, false otherwise.
     */
    private function writeSystemParametersToConfig($mainSiteUrl, $siteTempFilesFolder, $siteFilesFolder)
    {
        // Check permissions
        $this->throwForbiddenUnless(SecurityUtil::checkPermission($this->name . '::', '::', ACCESS_ADMIN));

        // get server zikula folder installation
        /** TODO: write rule to convert domains from www.foo.dom to foo.dom */
        $path = substr($_SERVER['PHP_SELF'], 0 ,  strrpos($_SERVER['PHP_SELF'], '/'));
        $basePath = substr($path, 0 ,  strrpos($path, '/'));
        $wwwroot = 'http://' . $_SERVER['HTTP_HOST'] . $basePath;

        // write parameter into the multisites_config.php file
        $fh = @fopen($this->configFile, 'r+');
        if ($fh == false) {
            fclose($fh);
            return LogUtil::registerError($this->__('Error: File config/multisites_config.php could not be found.'));
        }

        $lines = file($this->configFile);
        $newFileContent = '';
        $configPrefix = "ZConfig['Multisites']";

        foreach ($lines as $line_num => $line) {
            if (strpos($line, $configPrefix . "['multisites.enabled']") !== false && strpos($line, "ZConfig['Multisites']['multisites.mainsiteurl']") === false) {
                $line = str_replace('= 0', '= 1', $line);
            } elseif (strpos($line, $configPrefix . "['multisites.mainsiteurl']") !== false) {
                $line = str_replace('$mainsiteurl', $mainSiteUrl, $line);
            } elseif (strpos($line, $configPrefix . "['multisites.site_temp_files_folder']") !== false) {
                $line = str_replace('$site_temp_files_folder', '/' . $siteTempFilesFolder, $line);
            } elseif (strpos($line, $configPrefix . "['multisites.site_files_folder']") !== false) {
                $line = str_replace('$site_files_folder', '/' . $siteFilesFolder, $line);
            } elseif (strpos($line, $configPrefix . "['multisites.wwwroot']") !== false) {
                $line = str_replace('$wwwroot', $wwwroot, $line);
            } elseif (strpos($line, $configPrefix . "['multisites.sitedns']") !== false) {
                $line = str_replace('$basePath', $basePath, $line);
            }
            $newFileContent .= $line;
        }

        // write new content into the file
        $fh = @fopen($this->configFile, 'w+');
        if (!fwrite($fh, $newFileContent)) {
            fclose($fh);
            return LogUtil::registerError($this->__('Error: Could not write into the config/multiple_config.php file.'));
        }
        fclose($fh);

        return true;
    }

    /**
     * Writes multisites system parameters into the config/multisites_config.php file.
     *
     * @return boolean True if everything worked, false otherwise.
     */
    private function createAdditionalDirectories()
    {
        // Check permissions
        $this->throwForbiddenUnless(SecurityUtil::checkPermission($this->name . '::', '::', ACCESS_ADMIN));

        $sm = $this->serviceManager;

        // check if the sitesFilesFolder exists
        $path = $this->getVar('files_real_path', '');
        if ($path == '') {
            return LogUtil::registerError($this->__('The directory for storing the sites files is not defined. Check your configuration values.'));
        }
        if (!file_exists($path)) {
            return LogUtil::registerError($this->__('The directory for storing the sites files does not exist.'));
        }
        // check if the sitesFilesFolder is writeable
        if (!is_writeable($path)) {
            return LogUtil::registerError($this->__('The directory for storing the sites files is not writeable.'));
        }

        // create the main site folder
//         $path .= '/' . FormUtil::getPassedValue('sitedns', null, 'GET');
//         if (!file_exists($path) && !mkdir($path, 0777, true)) {
//             return LogUtil::registerError($this->__('Error creating the directory:') . ' ' . $path);
//         }

        // create the data folder
        $path .= '/' . $this->getVar('site_files_folder', '');
        if (!file_exists($path) && !@mkdir($path, 0777, true)) {
            return LogUtil::registerError($this->__('Error creating the directory:') . ' ' . $path);
        }

        return true;
    }
}
