<?php
/**
 * Multisites.
 *
 * @copyright Albert Pérez Monfort (Zikula)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @package Multisites
 * @author Albert Pérez Monfort <aperezm@xtec.cat>.
 * @link http://modulestudio.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio 0.7.0 (http://modulestudio.de).
 */

/**
 * Cache api base class.
 */
class Multisites_Api_Base_Cache extends Zikula_AbstractApi
{
    /**
     * Clear cache for given item. Can be called from other modules to clear an item cache.
     *
     * @param $args['ot']   the treated object type
     * @param $args['item'] the actual object
     */
    public function clearItemCache(array $args = array())
    {
        if (!isset($args['ot']) || !isset($args['item'])) {
            return;
        }
    
        $objectType = $args['ot'];
        $item = $args['item'];
    
        $controllerHelper = new Multisites_Util_Controller($this->serviceManager);
        $utilArgs = array('api' => 'cache', 'action' => 'clearItemCache');
        if (!in_array($objectType, $controllerHelper->getObjectTypes('controllerAction', $utilArgs))) {
            return;
        }
    
        if ($item && !is_array($item) && !is_object($item)) {
            $item = ModUtil::apiFunc($this->name, 'selection', 'getEntity', array('ot' => $objectType, 'id' => $item, 'useJoins' => false, 'slimMode' => true));
        }
    
        if (!$item) {
            return;
        }
    
        $instanceId = $item->createCompositeIdentifier();
    
        // Clear View_cache
        $cacheIds = array();
        switch ($objectType) {
            case 'site':
                $cacheIds[] = $objectType . '_view';
                
                
                $cacheIds[] = $objectType . '|' . 'manageExtensions';
                $cacheIds[] = $objectType . '|' . 'manageThemes';
                $cacheIds[] = $objectType . '|' . 'exportDatabaseAsTemplate';
                break;
            case 'template':
                $cacheIds[] = $objectType . '_view';
                
                
                $cacheIds[] = $objectType . '|' . 'reapply';
                break;
            case 'siteExtension':
                $cacheIds[] = $objectType . '_view';
                
                
                break;
            case 'project':
                $cacheIds[] = $objectType . '_view';
                
                
                break;
        }
    
        $view = Zikula_View::getInstance('Multisites');
        foreach ($cacheIds as $cacheId) {
            $view->clear_cache(null, $cacheId);
        }
    
    
        // Clear Theme_cache
        $cacheIds = array();
        $cacheIds[] = 'homepage'; // for homepage (can be assigned in the Settings module)
        switch ($objectType) {
            case 'site':
                $cacheIdPrefix = 'Multisites/' . $objectType . '/';
                $cacheIds[] = $cacheIdPrefix . 'view/'; // view function (list views)
                
                
                $cacheIds[] = $cacheIdPrefix . 'manageExtensions'; // manage extensions function
                $cacheIds[] = $cacheIdPrefix . 'manageThemes'; // manage themes function
                $cacheIds[] = $cacheIdPrefix . 'exportDatabaseAsTemplate'; // export database as template function
                break;
            case 'template':
                $cacheIdPrefix = 'Multisites/' . $objectType . '/';
                $cacheIds[] = $cacheIdPrefix . 'view/'; // view function (list views)
                
                
                $cacheIds[] = $cacheIdPrefix . 'reapply'; // reapply function
                break;
            case 'siteExtension':
                $cacheIdPrefix = 'Multisites/' . $objectType . '/';
                $cacheIds[] = $cacheIdPrefix . 'view/'; // view function (list views)
                
                
                break;
            case 'project':
                $cacheIdPrefix = 'Multisites/' . $objectType . '/';
                $cacheIds[] = $cacheIdPrefix . 'view/'; // view function (list views)
                
                
                break;
        }
        $theme = Zikula_View_Theme::getInstance();
        $theme->clear_cacheid_allthemes($cacheIds);
    }
}
